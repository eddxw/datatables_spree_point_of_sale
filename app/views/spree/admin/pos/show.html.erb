<link rel="stylesheet" href="//cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css" >
<script src="//cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>

<style>
#pos-order-table tr
{
  !transition: background  1.5s;
  -webkit-transition: background 2s;
  -moz-transition: background 2s;
  -ms-transition: background 2s;
  -o-transition: background 2s;
  transition: background 2s;
}
#pos-order-table tr.updated
{
  background-color: #88ff88;
}
</style>
<div class='col-sm-12 row'>
  <h4 class='col-sm-6'>Order No:
    <%= @order.number %>
  </h4>

  <h4 class='col-sm-6'>Order For:
    <%= link_to @order.email, edit_admin_user_path(@order.user) %></h4>

  <div class='col-sm-6'>
    <a href="/admin/pos/new" onclick="javascript:if (newwindow) newwindow.close()" class="button">
      Nueva Orden
    </a>
  </div>
  <div class='col-sm-6'>
    <a href="javascript:void(0);" id="associate_user_toggle" class="button">
      Cambiar Usuario
    </a>
  </div>
</div>

<div class='col-sm-9'>

  <%= form_tag associate_user_admin_pos_path(number: @order.number), id: "associate_user" do %>
  <div id="pos-tabs">
    <ul>
      <li>
        <a href="#associate_email">Buscar Usuario por email</a>
      </li>
      <li>
        <a href="#associate_new_user">Agregar nuevo usuario</a>
      </li>
    </ul>
    <div id="associate_email" class="commonfieldset">
      <div class="row">
        <div class="four columns alpha">
          <div class="field">
            <label>Email</label>
            <%= text_field_tag :email, '', size: 25 %>
            <br/>
          </div>
        </div>
      </div>
    </div>
    <!-- <div class="or_separator"><span>OR</span></div> -->
    <div id="associate_new_user" class="commonfieldset">
      <div class="row">
        <div class="four columns alpha">
          <div class="field">
            <label>Nuevo Email</label>
            <%= text_field_tag :new_email, nil, size: 25 %>
            <br/>
          </div>
        </div>
      </div>
    </div>
    <div class="four columns alpha">
      <div class="field">
        <%= button "Asociar Usuario" %>
      </div>
    </div>
  </div>
<% end %>

<table id='variants-datatable' data-source="<%= find_admin_pos_path(@order.number, format: :json) %>">
  <thead>
    <tr>
      <th>SKU</th>
      <th>Image</th>
      <th>Name</th>
      <th>Stock</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>


<div class="table-responsive">
  <table id='pos-order-table' class="index table table-condensed">
    <tr>
      <th><%= Spree.t('item_description') %></th>
      <th><%= Spree.t('quantity') %></th>
      <th>Disp.</th>
      <th></th>
      <th class="price"><%= Spree.t('price') %></th>
      <th class="discount_price"><%= "#{Spree.t('discount')}(%)" %></th>
      <th><%= Spree.t('remove') %><br><%= Spree.t('add') %></th>
      <th>Cambiar descuento</th>
    </tr>
    <%= render(@order.line_items) %>
  </table>
</div>

<% if @order.line_items.exists? %>
  <div class="alert alert-info" id="order-total" data-hook="order_details_total" style="text-align: right;">
    <%= Spree.t(:order_total) %>:
    <strong class="order-total">
      <%= @order.display_total %>
    </strong>
  </div>
<% end %>

<%= render "spree/admin/orders/adjustments", adjustments: @order.line_item_adjustments, order: @order, title: Spree.t(:line_item_adjustments) %>
<%= render "spree/admin/orders/adjustments", adjustments: @order.adjustments, order: @order, title: Spree.t(:order_adjustments) %>
<div style="overflow: hidden;">
  <%= button_link_to(Spree.t(:new_adjustment), new_admin_order_adjustment_url(@order), class: "btn-success", style: "float: right; margin-bottom: 5px;", icon: 'add') if can? :create, Spree::Adjustment %>
</div>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title"><%= Spree.t(:summary) %></h3>
  </div>
  <div class="table-responsive">
    <%= render "order_summary" %>
  </div>
</div>

<div class="belowtable row">
<%= button_to "Remover todos los artículos", admin_pos_clean_order_path(number: @order.number) , data: { confirm: "¿estás seguro?" }, class: 'btn btn-default' %>
</div>

<div class="row">

<%= form_tag update_payment_admin_pos_path(@order.number), id: "update_payment" do %>
  <div class="four rows alpha">
    <h4>Metodos de Pago</h4>
    <div class="field">
      <p>
      <% Spree::PaymentMethod.where("type='Spree::PaymentMethod::PointOfSale'").each do |method| %>
        <label>
          <%= radio_button_tag :payment_method_id, method.id, false, 'data-name': method.name %>
          <%= Spree.t(method.name, scope: :payment_methods, default: method.name) %>
        </label>
      <% end %>
      </p>
    </div>

    <div id="card_name" class="rows">
      <%= select_tag(:card_name, options_for_select(::CARD_TYPE, "#{@order.payments.first.try(:card_name)}"), include_blank: true, id: 'card_name_options') %>
      <%= button_tag "Confirmar", class: "fr btn btn-primary btn-success", data: { confirm:"¿estás seguro?", disable_with: "..." } %>
    </div>
  </div>
<% end %>
</div>
</div>

<div class='col-sm-3'>
  <% if @order.payment_state == 'paid' || try_spree_current_user.has_spree_role?('admin') %>
    <span id="spanlinkrecibo">
      <%= link_to("/admin/invoice/#{@order.number}/receipt", target:  "_blank", id: "linkrecibo") do %>
      <h4>
        <span class='glyphicon glyphicon-print'></span>
        Imprimir recibo
      </h4>
      <% end %>
    </span>
  <% end %>


<div class="stock_locations">
  <fieldset>
    <legend class='stock-location'>Cambiar ubicación</legend>
    <%= form_tag update_stock_location_admin_pos_path(@order.number), class: 'modify_stock_location_form' do %>
      <% user_stock_locations(spree_current_user).all.each do |stock_location| %>
        <div>
          <label style="display: flow-root;">
            <%= radio_button_tag :stock_location_id, stock_location.id, (stock_location.id == @order.pos_shipment.stock_location.id), id: "stock_location_#{ stock_location.id }", onchange: 'this.form.submit()', class: 'stock_location_checkbox' %>
            <%= stock_location.name %>
          </label>
        </div>
      <% end %>
      <br/>
      <%= submit_tag 'Actualizar', data: { confirm: "¿estás seguro?" }, class: 'btn btn-primary btn-success', style: 'display: none;' %>
    <% end %>
  </fieldset>
</div>


  <div class="search mart-10">
  <legend>Buscar & Agregar</legend>
    <%= form_tag(find_admin_pos_path(@order.number), method: :get, id: "product_search") do %>
      <input type="hidden" value="1" name="index">
      <div class="box">
        <p>
          <%= search_field_tag :sku, nil, class: 'aa-input-search', autocomplete: 'off', placeholder: "Buscar..." %>
          <%= button_tag class: 'btn btn-primary mart-10', type: 'submit' do %>
          <span class='icon icon-search'></span>
          <%= Spree.t("search") %>
          <% end %>
        </p>
      </div>
    <% end %>
  </div>
  <a href="/admin/pos/export" target="_blank"><%  image_tag("admin/pos/select.jpg" ) %></a>
</div>



<script>

  var client = algoliasearch('<%= ENV['ALGOLIA_APP_ID'] %>', '<%= ENV['ALGOLIA_API_KEY']%>');
  var products_index = client.initIndex('athspree');

  function runMyFunction(sku) {
    alert(sku);
  }
  $('#sku').autocomplete(
    {
      debug: true,
      templates: {
        dropdownMenu:
          '<div class="aa-dataset-producto"></div>'
      },
    },
    [
      {
        source: $.fn.autocomplete.sources.hits(products_index, {hitsPerPage: 7}),
        displayKey: 'sku',
        name: 'producto',
        templates: {
          header: '<div class="aa-suggestions-category">Productos</div>',
          suggestion: function(suggestion) {
            // var string = "runMyFunction(suggestion._highlightResult.sku.value);";
            return (
              '<a><img src="' +
                         suggestion.foto +
                         '">' +
                         '<span>' +
                         suggestion._highlightResult.name.value +
                         '</span><span>' +
                         suggestion._highlightResult.sku.value +
                         '</span><a/>'
            );
          }
          //empty: '<div class="aa-empty">No matching products</div>',
        }
      }
    ]
  );

  function readyFn( jQuery ) {
    var completada;
    completada = '<%= @order.payment_state %>';
    if (completada == 'paid') {
      var answer=confirm('¿Imprimir recibo?');
      if(answer) {
        $('#linkrecibo')[0].click();
      }
    }
  }
  $(window).on( "load", readyFn );

  jQuery(document).ready(function() {
    var oTable = $('#variants-datatable').dataTable({
      "lengthMenu": [[3, 5, 10], [3, 5, 10]],
      "processing": true,
      "serverSide": true,
      "ajax": $('#variants-datatable').data('source'),
      "pagingType": "full_numbers",
      "columns": [
        {"data": "sku"},
        {"data": "image"},
        {"data": "name"},
        {"data": "stock"},
        {"data": "actions"},
      ],
    });
    $("div.dataTables_filter input").unbind();
    $("div.dataTables_filter input").keyup( function (e) {
      e.preventDefault();
      if (e.keyCode == 13) {
        oTable.fnFilter( this.value );
      }
    } );
  });
</script>
